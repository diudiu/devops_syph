### 准备工作
1. 镜像  已上传至阿里云 版本号2.1.171030
2. 数据库更新脚本  已上传至de.digcredit.com  /home/docker/syph/sql/hh.rar
3. 升级用的compose.yml文件  docker-compose-171030.yml
4. 回滚用的compose.yml文件  rollback_to_2.1.171011.yml

### 升级
1. 备份mysql数据库
- 登录 de.digcredit.com  
- 备份脚本存放目录:  de.digcredit.com  /opt/dump/mysql_backup.sh
- 执行命令  /opt/dump/mysql_backup.sh

2. 更新数据库
- 登录 de.digcredit.com  cd /home/docker/syph/hh
- mysql -h 116.62.42.89 -u riskctl -p -e "use featurefactory; source do_loan_manager_info.sql;" 
- mysql -h 116.62.42.89 -u riskctl -p -e "use featurefactory; source do_p2p_telephone.sql;"
- mysql -h 116.62.42.89 -u riskctl -p -e "use featurefactory; source 201710311922-rule-engine-data.sql;"

3. 更新nginx配置文件
- mv  /usr/local/webserver/nginx/conf/conf.d/docker.conf  /usr/local/webserver/nginx/conf/conf.d/docker.conf.bk
- cp  /root/syph/nginx-dir/*.conf   /usr/local/webserver/nginx/conf/conf.d/

4. 更新compose.env里的端口号

5. 重启nginx 
- /usr/local/bin/nginx -t
- /usr/local/bin/nginx -s reload
- /usr/local/bin/nginx -s reopen

6. 更新代码
- 登录 116.62.45.245   cd /root/syph
- cat docker-compose-171031.yml > docker-compose.yml
- docker stack deploy -c  docker-compose.yml --with-registry-auth  stk4de

7. 登录后台,保存策略
   
### 出错回滚
1. 回滚数据库
- 登录 de.digcredit.com  
- cd /opt/dump/mysql/backup.1
- gunzip featurefactory.2017-10-29.gz
- mysql -h 116.62.42.89 -u riskctl -p -e "use featurefactory; source featurefactory.2017-10-29;" 

2. 回滚代码
- cd /root/syph
- docker stack deploy -c rollback_to_2.1.171011.yml --with-registry-auth  stk4de

3. 回滚compose.env

4. 回滚nginx
- mv  /usr/local/webserver/nginx/conf/conf.d/featurefactory.conf  /usr/local/webserver/nginx/conf/conf.d/featurefactory.conf.bk
- mv  /usr/local/webserver/nginx/conf/conf.d/rule_engine.conf  /usr/local/webserver/nginx/conf/conf.d/rule_engine.conf.bk
- mv  /usr/local/webserver/nginx/conf/conf.d/rule_engine_ui.conf  /usr/local/webserver/nginx/conf/conf.d/rule_engine_ui.bk
- mv  /usr/local/webserver/nginx/conf/conf.d/docker.conf.bk  /usr/local/webserver/nginx/conf/conf.d/docker.conf

5. 重启nginx
- /usr/local/bin/nginx -t
- /usr/local/bin/nginx -s reload
- /usr/local/bin/nginx -s reopen

6. 登录后台, 保存策略
   
